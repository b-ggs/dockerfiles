language: generic

env:
  global:
    - DOCKER_USERNAME=bxggs
    - DEFAULT_DOCKER_TAG=latest
    - DOCKER_CLI_EXPERIMENTAL=enabled
  jobs:
    - DOCKER_IMAGE=aria2 RELATIVE_PATH=aria2
    - DOCKER_IMAGE=autosub RELATIVE_PATH=autosub
    - DOCKER_IMAGE=markserv RELATIVE_PATH=markserv
    - DOCKER_IMAGE=md-to-pdf RELATIVE_PATH=md-to-pdf
    - DOCKER_IMAGE=openssl RELATIVE_PATH=openssl
    - DOCKER_IMAGE=qrencode RELATIVE_PATH=qrencode
    - DOCKER_IMAGE=pirate-get RELATIVE_PATH=pirate-get
    - DOCKER_IMAGE=pywal RELATIVE_PATH=pywal
    - DOCKER_IMAGE=youtube-dl RELATIVE_PATH=youtube-dl
    - DOCKER_IMAGE=tcd RELATIVE_PATH=tcd
    - DOCKER_IMAGE=nginx-autoindex RELATIVE_PATH=nginx-autoindex

services:
  - docker

before_install:
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
  - sudo apt update
  - sudo apt -y -o Dpkg::Options::="--force-confnew" install docker-ce qemu-user-static binfmt-support

script:
  - if [[ "$TRAVIS_BRANCH" == "master" ]]; then
      export DOCKER_TAG=$DEFAULT_DOCKER_TAG;
    else
      export DOCKER_TAG=$(echo "$TRAVIS_BRANCH" | awk '{ gsub("/", "-"); print $0 }');
    fi
  - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
  - docker buildx create --use
  - docker buildx build -t "$DOCKER_USERNAME/$DOCKER_IMAGE:$DOCKER_TAG" --platform linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6 --push "$RELATIVE_PATH"
